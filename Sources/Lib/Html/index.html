<!DOCTYPE html>
<html lang="en">
<head>

<title>Xcode Test Report</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/hyperapp"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/layzr.js/2.0.2/layzr.min.js"></script>

<style>

 body {
   font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック  Medium', meiryo, sans-serif;
   color: #222;
   margin: 0;

   display: flex;
   flex-direction: column;
   align-items: center;

   background-color: #fafafa;
 }

 .container {
   display: flex;
   flex-direction: column;
   align-items: center;
   max-width: 100%;
   padding-top: 64px;

   width: 85%;
   min-width: 85%;
 }

 /** header **/

 .header {
   position: fixed;
   top: 0;
   right: 0;
   left: 0;
   height: 64px;
   background-color: #fff;
   box-shadow: 0 3px 2px -2px rgba(200,200,200,0.2);
   display: flex;
   flex-direction: column;
   align-items: center;
 }

 .header-content {
   height: 100%;
   width: 85%;
   min-width: 85%;
   display: flex;
   flex-direction: row;
   align-items: center;
   justify-content: space-between;
 }

 .logo {
   height: 40px;
 }

 /** radio **/

 .radio input {
   display: none;
 }
 .radio label{
   display: block;
   float: left;
   cursor: pointer;
   width: 60px;
   margin: 0;
   padding: 5px;
   color: #2F80ED;
   font-size: 16px;
   text-align: center;
   line-height: 1;
   transition: .2s;

   border: solid 1px #2F80ED;
 }
 .radio label {
   border-left: none;
 }

 .radio label:first-of-type{
   border-radius: 3px 0 0 3px;
   border: solid 1px #2F80ED;
 }
 .radio label:last-of-type{
   border-radius: 0 3px 3px 0;
 }

 .radio input[type="radio"]:checked + label {
   background-color: #2F80ED;
   color: #fff;
 }


 /** Test **/

 .test-summary {
   margin-top: 30px;
 }

 .env-summary {
   margin-top: 10px;
 }

 .test-summary, .env-summary {
   align-self: flex-start;
 }

 .testable-summaries {
   width: 100%;
   min-width: 100%;
 }

 .testable-summary {
   width: 100%;
   min-width: 100%;
 }

 table.tests {
   border: none;
   border-spacing: 0px;
   table-layout: fixed;
   min-width: 100%;
   max-width: 100%;
   word-break: break-all;
 }

 table.tests td {
   border: solid 1px gray;
 }

 table.tests td.test-status {
   border: solid 1px gray;
   text-align: center;
 }

.test-body-2 {
  padding-left: 0.8em;
}

.test-body-3 {
  padding-left: 1.5em;
  padding-right: 1.5em;
}

 .test-status {
   height: 30px;
   width:  30px;
   min-width:  30px;
   min-width:  30px;
 }

 tr.status-pkg td.test-status {
   padding-left: 2.8em;
   text-align: left;
   font-weight: bold;
   background-color: #7fbec2;
   border-color: #6cbfbc;
 }


 tr.status-pkg .test-body,  tr.status-pkg .test-attachment, tr.status-pkg .test-duration {
   background-color: #c3e5e6;
 }

 tr.status-pkg .test-name {
   font-weight: bold;
 }

 tr.status-pkg td {
   border-color: #abd9da;
 }

 tr.status-success td.test-status {
   background-color: #b9e0bc;
   border-color: #9bdc94;
   color: #5bbc54;
 }

 tr.status-success td {
   border-color: #ededed;
 }

 tr.status-failure td {
   background-color: #f5dde0;
 }

 tr.status-failure td.test-status {
   background-color: #f2c5c9;
   border-color: #f9a8b1;
   color: red;
 }

 tr.status-failure td {
   border-color: #f2cacf;
 }

 tr.status-failure .test-name {
 }

 .test-name  {
   padding-top: 0.5rem;
   padding-bottom: 0.5rem;
 }

 .test-name-and-result {
   display: flex;
   flex-direction: column;
   padding-top: 0.6em;
   padding-bottom: 0.6em;
 }

 tr.status-pkg .test-name-and-result, tr.status-success .test-name-and-result {
   display: flex;
   flex-direction: column;
   justify-content: center;
 }

 /** failure table **/

 .failure-summary {
   margin-top: 0.5em;
   padding-top: 0.5em;
   padding-left: 0em;
   display: flex;
   flex-direction: column;

   border-top: solid 1px #f9a8b1;
 }

 .failure-message {
   margin-top: 0.0em;
 }

 .failure-file {
   color: #555;
   margin-top: 0.5em;
   padding-left: 1em;
 }

 /** attachment **/

 .images {
   display: flex;
   flex-direction: row;
   flex-wrap: wrap;
   margin-top: 1em;
 }

 figure.attachment-image, img.attachment-image {
   width: 140px;
   -webkit-margin-start: 0;
   -webkit-margin-end: 25px;
   margin-left: 0;
   margin-right: 25px;
 }

 figure figcaption {
   text-align: center;
 }

 /** test summary **/

 .test-target {
   display: flex;
   flex-direction: row;
   margin-top: 2rem;
   margin-bottom: 0.7rem;
   align-items: baseline;
 }

 .test-target-name {
   font-size: 1.0rem;
   font-weight: bold;
 }

 .testable-summary .test-target-summary {
   font-size: 1.0rem;
   margin-left: 0.8rem;
 }

 .test-target-summary, .test-target-summary div {
   display: flex;
   flex-direction: row;
   align-items: baseline;
 }

 .test-target-summary-num {
   font-size: 1.0rem;
   margin-right: 0.3rem;
 }

 .test-target-summary-passed {
   margin-right: 0.4rem;
 }

 .test-target-summary-failed {
   color: red;
 }

 .test-target-summary-failed-zero {
   display: none;
 }

 /** duration **/

 .test-duration {
   word-break: keep-all;
   text-align: center;
   padding-left: 0.5rem;
   padding-right: 0.5rem;
   max-width: 4rem;
   width: 4rem;
 }

</style>
</head>

<body>

<script>
 const h = hyperapp.h;
 const app = hyperapp.app;
 const layzr = Layzr();

 const flatten = nested => Array.prototype.concat.apply([], nested);

 const state = {
   filter: "all",
   report: __report_data__,
   reportSummary: __report_summary_data__,
 };

 const actions = {
   setFilter: value => state => Object.assign({}, state, { filter: value }),
 };

 /** View **/

 const testSummaryText = (testSummary) => {
   return h("div", {"class": "test-target-summary"}, [
     h("div", {"class": "test-target-summary-passed"}, [
       h("div", {"class": "test-target-summary-num"}, testSummary.tests),
       h("div", {}, testSummary.failed > 0 ? "tests with " : "tests.")]),
   ].concat((() => {
     if (testSummary.failed > 0) {
       return h("div", {"class": testSummary.failed > 0 ? "test-target-summary-failed" : "test-target-summary-failed-zero"}, [
         h("div", {"class": "test-target-summary-num"}, testSummary.failed),
         h("div", {}, "failures.")]);
     } else {
       return [];
     }
   })()));
 };

 const testableSummaryView = (testableSummary, reportSummary, filter) => {
   let testSummary = reportSummary.testableSummary[testableSummary.TestName];


   return h("div", {"class": "testable-summary"}, [
     h("div", {"class": "test-target"}, [
       h("div", {"class": "test-target-name"}, `${testableSummary.TestName}`),
       testSummaryText(testSummary),
     ]),
     h("table", {"class": "tests", border: 0 },
       testableSummary.Tests.map(test => testView(test, filter, 0))),
   ]
   );
 };

 const testView = (test, filter, level) => {
   if (level < 2) {
     return test.Subtests ? test.Subtests.map(test => testView(test, filter, level + 1)).filter(v => v) : [];
   }

   if (filter == "failed" && test.TestStatus == "Success") return null;
   if (filter == "passed" && test.TestStatus == "Failure") return null;

   let isPkg = !test.TestStatus;

   let statusMark = status => {
     if (status == "Success") return "✓";
     if (status == "Failure") return "✗";
   };

   let statusClass = status => {
     if (status == "Success") return "status-success";
     if (status == "Failure") return "status-failure";
     return "status-pkg";
   };

   let failureSummary = summary => {
     let failureFile = `${summary.FileName}: ${summary.LineNumber}`;

     return h("div", {"class": "failure-summary"}, [
       h("div", {"class": "failure-message"}, summary.Message),
       h("div", {"class": "failure-file"}, failureFile),
     ]);
   };

   let imagesSummary = () => {
     let imageFiles = images();
     let oncreate = () => { layzr.update(); layzr.check(); };

     if (imageFiles.length == 0) return null;

     return h("div", {"class": "images"},
              imageFiles.map(image =>
                h("figure", { oncreate, "class": "attachment-image" }, [
                  h("a", { href: image.file, target: "_blank" }, [
                    h("img", {"class": "attachment-image", "data-normal": image.file}, [])
                  ]),
                  h("figcaption", {}, image.name),
                ])
              )
     );
   };

   let images = () => {
     if (!test.ActivitySummaries) return [];

     return flatten(test.ActivitySummaries.map(activitySummary => {
       if (!activitySummary.Attachments) return [];
       if (activitySummary.ActivityType != "com.apple.dt.xctest.activity-type.attachmentContainer") return [];

       return activitySummary.Attachments.map ( attachment => {
         let file = `Attachments/${attachment.Filename}`;
         return { file, name: attachment.Name };
       });
     }));
   };

   let testNameAndResult = () => {
     let results = [];

     let failureSummaries = [];
     if (test.FailureSummaries && test.FailureSummaries.length > 0) {
       failureSummaries = test.FailureSummaries.map(failureSummary);
     }

     results = results.concat(failureSummaries);

     let imageNodes = imagesSummary();
     if (imageNodes) results.push(imageNodes);

     let hasResult = failureSummaries.length > 0 || imageNodes;

     return h("div", {"class": hasResult ? "test-name-and-result" : "" }, [
       h("div", {"class": "test-name"}, test.TestName),
     ].concat(results));
   };


   let subTests = test.Subtests ? flatten(test.Subtests.map(test => testView(test, filter, level + 1)).filter(v => v)) : [];

   if (isPkg && subTests.length == 0) return null;

   return [
     h("tr", {"class": `test ${statusClass(test.TestStatus)}`}, [
     ].concat(
       (isPkg ? (
         [
           h("td", {"class": 'test-status', "colspan": isPkg ? '2' : '1' }, test.TestName),
         ]
       ) : (
         [
           h("td", {"class": 'test-status', }, statusMark(test.TestStatus)),
           h("td", {"class": `test-body test-body-${level}`}, testNameAndResult()),
         ]
       )),
       [h("td", {"class": 'test-duration'}, Math.round(test.Duration * 100) / 100  + "s")],
     ))
   ].concat(subTests) ;
 }

 const header = (state, actions) => {
   let filters = [
     { value: "all", text: "All" },
     { value: "passed", text: "Passed" },
     { value: "failed", text: "Failed" },
   ];

   return h("div", {"class": "header"}, [
     h("div", {"class": "header-content"}, [
       h("img", {"class": "logo", src: "XcodeTestReporter.svg"}, []),
       h("div", {"class": "filter radio"}, flatten(filters.map( filter => [
         h("input", {type: "radio",
                     name: "filter",
                     value: filter.value,
                     id: filter.value,
                     checked: state.filter == filter.value ? "1" : "",
                     onchange: (v) => { actions.setFilter(filter.value); },
         }, []),
         h("label", {"for": filter.value, "class": "radio-label"}, filter.text),
       ]))),
     ]),
   ]);
 };


 const testSummary = state => {
   let s = state.reportSummary.testSummary;

   return h('div', {"class": "test-summary"}, [
     testSummaryText(s)
   ]);
 };

 const envSummary = state => {
   let targetDevice = state.report.RunDestination.TargetDevice;
   let pc = state.report.RunDestination.LocalComputer;

   let text = `${targetDevice.ModelName}, ${targetDevice.OperatingSystemVersion}, ${targetDevice.Platform.Name}`;

   return h('div', {"class": "env-summary"}, [
     h("div", {}, text)
   ]);
 };

 const view = (state, actions) => {
   return h("div", {"class": "container"},
            header(state, actions),

            testSummary(state),
            envSummary(state),
            h("div", {"class": "testable-summaries"}, [
              state.report.TestableSummaries.map(summary =>
                testableSummaryView(summary, state.reportSummary, state.filter)),
            ])
   );
 };

 const container = document.body;
 app(state, actions, view, container);

 window.addEventListener('scroll', () => {
   layzr.check();
 });

 window.addEventListener('resize', () => {
   layzr.check();
 });

</script>

</body>

</html>
