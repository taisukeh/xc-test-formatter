<!DOCTYPE html>
<html lang="en">
<head>

<title>Xcode Test Report</title>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/hyperapp"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/layzr.js/2.0.2/layzr.min.js"></script>

<style>

 .container {
   display: flex;
   flex-direction: column;
   align-items: center;

   max-width: 100%;
 }

 .testable-summary {
   width: 85%;
   min-width: 85%;
 }

 table.tests {
   border: none;
   border-spacing: 0px;
   table-layout: fixed;
   min-width: 100%;
   max-width: 100%;
   word-break: break-all;
 }

 table.tests td {
   border: solid 1px gray;
 }

 table.tests td.test-status {
   border: solid 1px gray;
   text-align: center;
 }

.test-body-2 {
  padding-left: 0.8em;
}

.test-body-3 {
  padding-left: 2em;
  padding-right: 2em;
}

 .test-status {
   height: 30px;
   width:  30px;
   min-width:  30px;
   min-width:  30px;
 }

 tr.status-pkg td.test-status {
   background-color: #7fbec2;
   border-color: #6cbfbc;
 }


 tr.status-pkg .test-body,  tr.status-pkg .test-attachment, tr.status-pkg .test-duration {
   background-color: #c3e5e6;
 }

 tr.status-pkg .test-name {
   font-weight: bold;
 }

 tr.status-pkg td {
   border-color: #abd9da;
 }

 tr.status-success td.test-status {
   background-color: #b9e0bc;
   border-color: #9bdc94;
   color: #5bbc54;
 }

 tr.status-success td {
   border-color: #ededed;
 }

 tr.status-failure td {
   background-color: #f5dde0;
 }

 tr.status-failure td.test-status {
   background-color: #f2c5c9;
   border-color: #f9a8b1;
   color: red;
 }

 tr.status-failure td {
   border-color: #f2cacf;
 }

 tr.status-failure .test-name {
 }

 .test-name  {
   padding-top: 0.5rem;
   padding-bottom: 0.5rem;
 }

 .test-name-and-result {
   display: flex;
   flex-direction: column;
   padding-top: 0.6em;
   padding-bottom: 0.6em;
 }

 tr.status-pkg .test-name-and-result, tr.status-success .test-name-and-result {
   display: flex;
   flex-direction: column;
   justify-content: center;
 }

 /** failure table **/

 .failure-summary {
   margin-top: 0.5em;
   padding-top: 0.5em;
   padding-left: 0em;
   display: flex;
   flex-direction: column;

   border-top: solid 1px #f9a8b1;
 }

 .failure-message {
   margin-top: 0.0em;
 }

 .failure-file {
   color: #555;
   margin-top: 0.5em;
   padding-left: 1em;
 }

 /** attachment **/

 .images {
   display: flex;
   flex-direction: row;
   flex-wrap: wrap;
   margin-top: 1em;
 }

 figure.attachment-image, img.attachment-image {
   width: 140px;
   -webkit-margin-start: 0;
   -webkit-margin-end: 25px;
   margin-left: 0;
   margin-right: 25px;
 }

 figure figcaption {
   text-align: center;
 }

 /** duration **/

 .test-duration {
   word-break: keep-all;
   text-align: center;
   padding-left: 0.5rem;
   padding-right: 0.5rem;
 }

</style>
</head>

<body>

<script>
 const h = hyperapp.h;
 const app = hyperapp.app;
 const layzr = Layzr();

 const flatten = nested => Array.prototype.concat.apply([], nested);

 const state = __state_data__;

 const actions = {
   down: value => state => ({ count: state.count - value }),
   up: value => state => ({ count: state.count + value })
 };

/** View **/

 const testableSummaryView = (testableSummary) =>
   h("div", {"class": "testable-summary"}, [
     h("h1", {}, testableSummary.TestName),
     h("table", {"class": "tests", border: 0 },
       testableSummary.Tests.map(test => testView(test, 0))),
   ]
   );

 const testView = (test, level) => {
   if (level < 2) {
     return test.Subtests ? test.Subtests.map(test => testView(test, level + 1)) : [];
   }

   let statusMark = status => {
     if (status == "Success") return "✓";
     if (status == "Failure") return "✗";
   };

   let statusClass = status => {
     if (status == "Success") return "status-success";
     if (status == "Failure") return "status-failure";
     return "status-pkg";
   };

   let failureSummary = summary => {
     let failureFile = `${summary.FileName}: ${summary.LineNumber}`;

     return h("div", {"class": "failure-summary"}, [
       h("div", {"class": "failure-message"}, summary.Message),
       h("div", {"class": "failure-file"}, failureFile),
     ]);
   };

   let imagesSummary = () => {
     let imageFiles = images();
     let oncreate = () => { layzr.update(); layzr.check(); };

     if (imageFiles.length == 0) return null;

     return h("div", {"class": "images"},
              imageFiles.map(image =>
                h("figure", { oncreate, "class": "attachment-image" }, [
                  h("a", { href: image.file, target: "_blank" }, [
                    h("img", {"class": "attachment-image", "data-normal": image.file}, [])
                  ]),
                  h("figcaption", {}, image.name),
                ])
              )
     );
   };

   let images = () => {
     if (!test.ActivitySummaries) return [];

     return flatten(test.ActivitySummaries.map(activitySummary => {
       if (!activitySummary.Attachments) return [];
       if (activitySummary.ActivityType != "com.apple.dt.xctest.activity-type.attachmentContainer") return [];

       return activitySummary.Attachments.map ( attachment => {
         let file = `Attachments/${attachment.Filename}`;
         return { file, name: attachment.Name };
       });
     }));
   };

   let testNameAndResult = () => {
     let results = [];

     let failureSummaries = [];
     if (test.FailureSummaries && test.FailureSummaries.length > 0) {
       failureSummaries = test.FailureSummaries.map(failureSummary);
     }

     results = results.concat(failureSummaries);

     let imageNodes = imagesSummary();
     if (imageNodes) results.push(imageNodes);

     let hasResult = failureSummaries.length > 0 || imageNodes;

     return h("div", {"class": hasResult ? "test-name-and-result" : "" }, [
       h("div", {"class": "test-name"}, test.TestName),
     ].concat(results));
   };

   return [
     h("tr", {"class": `test ${statusClass(test.TestStatus)}`}, [
       h("td", {"class": 'test-status'}, statusMark(test.TestStatus)),
       h("td", {"class": `test-body test-body-${level}`}, testNameAndResult()),
       h("td", {"class": 'test-duration'}, Math.round(test.Duration * 100) / 100  + "s"),
     ])
   ].concat(
     test.Subtests ? flatten(test.Subtests.map(test => testView(test, level + 1))) : []
   );
 }

 const view = (report, actions) => {
   return h("div", {"class": "container"},
            report.TestableSummaries.map(testableSummaryView),
   );
 };

 const container = document.body;
 app(state, actions, view, container);

 window.addEventListener('scroll', () => {
   layzr.check();
 });

 window.addEventListener('resize', () => {
   layzr.check();
 });

</script>

</body>

</html>
